<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Ujian Aman - Sumatif Akhir Semester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; /* Mencegah blok teks */ }
        iframe { width: 100%; height: calc(100vh - 50px); border: none; }
        
        /* Animasi kedip untuk warning (TEMA BIRU) */
        @keyframes pulse-blue {
            0% { background-color: rgba(30, 58, 138, 0.95); } /* Blue 900 */
            50% { background-color: rgba(29, 78, 216, 0.95); } /* Blue 700 */
            100% { background-color: rgba(30, 58, 138, 0.95); }
        }
        
        .warning-overlay {
            animation: pulse-blue 2s infinite;
        }

        .blocked-overlay {
            background-color: #0f172a; /* Slate 900 (Dark Blue-ish) */
            cursor: not-allowed; /* Kursor dilarang */
        }

        /* Scrollbar untuk list mapel admin */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #2d3748; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4a5568; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100" oncontextmenu="return false;">

    <!-- HALAMAN SETUP (Siswa Memilih Mapel) -->
    <div id="setup-screen" class="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
        <div class="max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 relative">
            
            <!-- Tombol Admin Tersembunyi -->
            <button onclick="openAdminPanel()" class="absolute top-4 right-4 text-gray-600 hover:text-white transition" title="Pengaturan Guru">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>

            <div class="flex justify-center mb-6">
                <i data-lucide="shield-check" class="w-16 h-16 text-blue-500"></i>
            </div>
            <h1 class="text-2xl font-bold text-center mb-2">Portal Ujian Aman</h1>
            <p class="text-gray-400 text-center mb-6 text-sm">Sumatif Akhir Semester</p>
            
            <div class="space-y-4">
                <!-- Input Identitas Siswa -->
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Nama Lengkap / NIS:</label>
                    <input type="text" id="student-name" placeholder="Masukkan Nama Anda" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-blue-500 focus:outline-none text-white transition">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Pilih Mata Pelajaran:</label>
                    <select id="subject-select" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-blue-500 focus:outline-none text-white transition appearance-none">
                        <option value="" disabled selected>-- Pilih Soal Ujian --</option>
                        <!-- Opsi akan diisi via JS -->
                    </select>
                </div>
                
                <div class="bg-blue-900/30 p-4 rounded border border-blue-800">
                    <h3 class="font-bold text-blue-400 text-sm mb-2"><i data-lucide="info" class="inline w-4 h-4 mr-1"></i> Aturan Sistem:</h3>
                    <ul class="list-disc list-inside text-xs text-gray-300 space-y-1">
                        <li>Dilarang pindah tab atau minimize browser.</li>
                        <li>Toleransi pelanggaran terbatas.</li>
                        <li>Jika melanggar batas, <strong>layar akan terkunci total selama 3 menit</strong>.</li>
                        <li>Segala aktivitas perpindahan aplikasi akan <strong>tercatat di log guru</strong>.</li>
                    </ul>
                </div>

                <button onclick="startExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded transition flex items-center justify-center gap-2">
                    <i data-lucide="play"></i> Mulai Ujian
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ADMIN (Password Protected) -->
    <div id="admin-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-lg rounded-lg shadow-xl border border-gray-600 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white">Pengaturan Soal (Admin)</h2>
                <button onclick="closeAdminPanel()" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto custom-scroll flex-1">
                
                <!-- Konfigurasi Logger -->
                <div class="bg-gray-700/30 p-3 rounded mb-4 border border-gray-600">
                    <h3 class="text-sm font-bold text-green-400 mb-2 flex items-center gap-2">
                        <i data-lucide="sheet"></i> Integrasi Spreadsheet
                    </h3>
                    <p class="text-xs text-gray-400 mb-2">Masukkan URL Google Apps Script Web App untuk mencatat pelanggaran.</p>
                    <input type="text" id="logger-url-input" placeholder="https://script.google.com/macros/s/..." class="w-full mb-2 p-2 rounded bg-gray-900 border border-gray-600 text-white text-xs">
                    <button onclick="saveLoggerUrl()" class="w-full bg-gray-600 hover:bg-gray-500 text-white py-1 rounded text-xs">Simpan URL Logger</button>
                </div>

                <!-- Input Form Soal -->
                <div class="bg-gray-700/50 p-3 rounded mb-4">
                    <h3 class="text-sm font-bold text-blue-400 mb-2">Tambah Soal Baru</h3>
                    <input type="text" id="new-subject-name" placeholder="Nama Mapel (Cth: Matematika)" class="w-full mb-2 p-2 rounded bg-gray-900 border border-gray-600 text-white text-sm">
                    <input type="text" id="new-subject-url" placeholder="Link Google Form/CBT" class="w-full mb-2 p-2 rounded bg-gray-900 border border-gray-600 text-white text-sm">
                    <button onclick="addSubject()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm font-bold">
                        + Tambah ke Daftar
                    </button>
                </div>

                <!-- List Mapel -->
                <h3 class="text-sm font-bold text-gray-300 mb-2">Daftar Soal Tersimpan:</h3>
                <ul id="admin-subject-list" class="space-y-2">
                    <!-- List items via JS -->
                </ul>
            </div>
            
            <div class="p-4 border-t border-gray-700 text-right">
                <button onclick="closeAdminPanel()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm">Tutup</button>
            </div>
        </div>
    </div>

    <!-- HALAMAN UJIAN UTAMA -->
    <div id="exam-interface" class="hidden h-screen flex flex-col">
        <!-- Header Status -->
        <div class="h-[50px] bg-gray-900 text-white flex items-center justify-between px-4 shadow-md z-10">
            <div class="flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-blue-400"></i>
                <div class="flex flex-col leading-tight">
                    <span class="font-semibold text-sm md:text-base" id="active-subject-name">Ujian Berlangsung</span>
                    <span class="text-[10px] text-gray-400" id="active-student-name">Siswa</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 rounded bg-green-900/50 border border-green-700 text-green-400 text-xs md:text-sm transition-colors">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    Status: Aman
                </div>
                <div class="font-mono text-sm" id="tolerance-display">Sisa Toleransi: 60dtk</div>
            </div>
        </div>

        <!-- Container Soal -->
        <div class="flex-1 relative bg-white">
            <iframe id="exam-frame" src="" allow="camera; microphone; fullscreen"></iframe>
        </div>
    </div>

    <!-- OVERLAY PERINGATAN (Muncul saat ganti tab) - TEMA BIRU -->
    <div id="warning-overlay" class="hidden fixed inset-0 z-50 warning-overlay flex flex-col items-center justify-center text-white p-8 text-center">
        <i data-lucide="alert-circle" class="w-32 h-32 mb-6 text-blue-300"></i>
        <h1 class="text-4xl font-bold mb-4">PERINGATAN AKTIVITAS!</h1>
        <p class="text-xl mb-4 max-w-2xl">
            Sistem mendeteksi Anda meninggalkan halaman ujian.<br>
            Aktivitas ini dilaporkan sebagai tindakan multitasking/membuka aplikasi lain.
        </p>
        <div class="text-4xl font-mono font-bold" id="overlay-tolerance-timer">
            60
        </div>
        <p class="mt-4 text-sm text-blue-200">Kembali segera sebelum akses dikunci!</p>
    </div>

    <!-- OVERLAY SUSPENSI (Hukuman 3 Menit) - TEMA BIRU -->
    <div id="suspension-overlay" class="hidden fixed inset-0 z-[60] blocked-overlay flex flex-col items-center justify-center text-white p-8 text-center">
        <i data-lucide="lock" class="w-24 h-24 mb-6 text-blue-500"></i>
        <h1 class="text-3xl font-bold mb-2 text-blue-500">PERANGKAT TERKUNCI</h1>
        <p class="text-lg text-gray-300 mb-6 max-w-xl">
            Akses Anda dimatikan sementara karena pelanggaran disiplin.<br>
            Keyboard dan kontrol browser dinonaktifkan.
        </p>
        
        <div class="bg-gray-800 p-8 rounded-full border-4 border-blue-600 w-48 h-48 flex items-center justify-center mb-8 relative">
            <div class="text-4xl font-mono font-bold text-white" id="suspension-timer">03:00</div>
            <span class="absolute -bottom-8 text-sm text-gray-400">Waktu Tunggu</span>
        </div>

        <button id="btn-resume-exam" onclick="resumeExam()" disabled class="px-8 py-3 bg-gray-600 text-gray-400 font-bold rounded cursor-not-allowed transition hover:bg-blue-600 hover:text-white">
            LANJUTKAN UJIAN
        </button>
        <p id="resume-hint" class="mt-2 text-xs text-gray-500">Menunggu pembukaan kunci otomatis...</p>
    </div>

    <script>
        lucide.createIcons();

        // --- KONFIGURASI ADMIN ---
        const ADMIN_PASSWORD = "cHemistry"; 
        const MAX_TOLERANCE = 10; 
        const SUSPENSION_TIME = 180; // 3 Menit

        // --- STATE VARIABLES ---
        let currentTolerance = MAX_TOLERANCE;
        
        // --- INISIALISASI SOAL DENGAN IPA DEFAULT ---
        const defaultSubject = {
            id: "ipa-default-001",
            name: "Ilmu Pengetahuan Alam (IPA)",
            url: "https://docs.google.com/forms/d/e/1FAIpQLSd7GJN7nCVAMhPq1dcW9A6RgWtpIRy7SoekaKuV2vIiq5u0XA/viewform?usp=dialog"
        };

        let storedSubjects = JSON.parse(localStorage.getItem('examSubjects')) || [];
        const isIpaExist = storedSubjects.some(s => s.url === defaultSubject.url);
        if (!isIpaExist) {
            storedSubjects.unshift(defaultSubject);
            localStorage.setItem('examSubjects', JSON.stringify(storedSubjects));
        }
        
        let subjects = storedSubjects;
        let loggerUrl = localStorage.getItem('loggerUrl') || ""; 
        let isExamActive = false;
        let isSuspended = false;
        let toleranceInterval = null;
        let suspensionInterval = null;
        let currentStudentName = "";

        // --- DOM ELEMENTS ---
        const els = {
            setupScreen: document.getElementById('setup-screen'),
            examInterface: document.getElementById('exam-interface'),
            adminModal: document.getElementById('admin-modal'),
            subjectSelect: document.getElementById('subject-select'),
            studentName: document.getElementById('student-name'),
            loggerInput: document.getElementById('logger-url-input'),
            subjectList: document.getElementById('admin-subject-list'),
            inputs: {
                name: document.getElementById('new-subject-name'),
                url: document.getElementById('new-subject-url')
            },
            frame: document.getElementById('exam-frame'),
            warning: document.getElementById('warning-overlay'),
            suspension: document.getElementById('suspension-overlay'),
            displays: {
                tolerance: document.getElementById('tolerance-display'),
                overlayTolerance: document.getElementById('overlay-tolerance-timer'),
                suspension: document.getElementById('suspension-timer'),
                subjectName: document.getElementById('active-subject-name'),
                studentNameDisplay: document.getElementById('active-student-name')
            },
            btnResume: document.getElementById('btn-resume-exam'),
            resumeHint: document.getElementById('resume-hint')
        };

        // --- INITIALIZATION ---
        function init() {
            renderSubjectOptions();
            renderAdminList();
            els.loggerInput.value = loggerUrl; 
        }
        init();

        // --- SECURITY: KEYBOARD BLOCKER ---
        // Memblokir tombol keyboard saat suspensi
        document.addEventListener('keydown', function(e) {
            if (isSuspended) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            
            // Opsional: Memblokir inspect element / save page
            if ((e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 's') || e.key === 'F12') {
                e.preventDefault();
            }
        }, true);

        // --- LOGGER FUNCTION ---
        function logActivity(action, details) {
            if (!loggerUrl) return; 

            const payload = {
                name: currentStudentName,
                subject: els.displays.subjectName.textContent,
                action: action,
                details: details
            };

            fetch(loggerUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(err => console.error("Gagal log ke server", err));
        }

        // --- ADMIN FUNCTIONS ---
        function openAdminPanel() {
            const pass = prompt("Masukkan Password Admin:");
            if (pass === ADMIN_PASSWORD) {
                els.adminModal.classList.remove('hidden');
            } else if (pass !== null) {
                alert("Password Salah!");
            }
        }

        function closeAdminPanel() {
            els.adminModal.classList.add('hidden');
        }

        function saveLoggerUrl() {
            const url = els.loggerInput.value.trim();
            localStorage.setItem('loggerUrl', url);
            loggerUrl = url;
            alert("URL Logger tersimpan!");
        }

        function addSubject() {
            const name = els.inputs.name.value.trim();
            const url = els.inputs.url.value.trim();

            if (!name || !url) return alert("Nama dan URL harus diisi!");
            
            subjects.push({ id: Date.now(), name, url });
            saveSubjects();
            
            els.inputs.name.value = "";
            els.inputs.url.value = "";
            
            renderSubjectOptions();
            renderAdminList();
        }

        function deleteSubject(id) {
            if(confirm("Hapus soal ini?")) {
                subjects = subjects.filter(s => s.id !== id);
                saveSubjects();
                renderSubjectOptions();
                renderAdminList();
            }
        }

        function saveSubjects() {
            localStorage.setItem('examSubjects', JSON.stringify(subjects));
        }

        function renderSubjectOptions() {
            els.subjectSelect.innerHTML = '<option value="" disabled selected>-- Pilih Soal Ujian --</option>';
            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.url;
                opt.textContent = s.name;
                els.subjectSelect.appendChild(opt);
            });
        }

        function renderAdminList() {
            els.subjectList.innerHTML = '';
            if (subjects.length === 0) {
                els.subjectList.innerHTML = '<li class="text-gray-500 text-xs italic">Belum ada soal.</li>';
                return;
            }
            subjects.forEach(s => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-900 p-2 rounded border border-gray-700";
                li.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-white text-sm">${s.name}</div>
                        <div class="text-xs text-gray-500 truncate w-48">${s.url}</div>
                    </div>
                    <button onclick="deleteSubject(${s.id})" class="text-red-400 hover:text-red-300 p-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                els.subjectList.appendChild(li);
            });
            lucide.createIcons();
        }

        // --- EXAM LOGIC ---
        function startExam() {
            const url = els.subjectSelect.value;
            const name = els.subjectSelect.options[els.subjectSelect.selectedIndex]?.text;
            const student = els.studentName.value.trim();

            if (!student) return alert("Harap isi Nama Lengkap / NIS Anda!");
            if (!url) return alert("Silakan pilih mata pelajaran terlebih dahulu!");

            currentStudentName = student;
            
            els.frame.src = url;
            els.displays.subjectName.textContent = name;
            els.displays.studentNameDisplay.textContent = student;
            
            els.setupScreen.classList.add('hidden');
            els.examInterface.classList.remove('hidden');
            
            isExamActive = true;
            currentTolerance = MAX_TOLERANCE;
            updateToleranceDisplay();
            
            logActivity("START", "Memulai ujian"); 

            enterFullscreen();
        }

        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(() => {});
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            }
        }

        // --- DETECTION & PENALTY SYSTEM ---
        
        document.addEventListener("visibilitychange", () => {
            if (!isExamActive || isSuspended) return;

            if (document.hidden) {
                // User keluar
                els.warning.classList.remove('hidden');
                document.title = "⚠️ KEMBALI!";
                
                logActivity("WARNING", "Keluar tab / minimize"); 

                if (!toleranceInterval) {
                    toleranceInterval = setInterval(() => {
                        currentTolerance--;
                        updateToleranceDisplay();
                        
                        if (currentTolerance <= 0) {
                            triggerSuspension();
                        }
                    }, 1000); 
                }

            } else {
                // User kembali
                els.warning.classList.add('hidden');
                document.title = "Portal Ujian Aman";
                clearInterval(toleranceInterval);
                toleranceInterval = null;
                
                // Pastikan kembali fullscreen
                enterFullscreen();
            }
        });

        function updateToleranceDisplay() {
            els.displays.tolerance.textContent = `Sisa Toleransi: ${currentTolerance}dtk`;
            els.displays.overlayTolerance.textContent = currentTolerance;
        }

        function triggerSuspension() {
            isSuspended = true;
            clearInterval(toleranceInterval);
            toleranceInterval = null;
            
            logActivity("SUSPEND", "Terkena hukuman suspensi 3 menit"); 

            els.warning.classList.add('hidden');
            els.suspension.classList.remove('hidden');
            els.frame.style.pointerEvents = 'none'; 
            
            els.btnResume.disabled = true;
            els.btnResume.classList.remove('bg-blue-600', 'text-white', 'cursor-pointer');
            els.btnResume.classList.add('bg-gray-600', 'text-gray-400', 'cursor-not-allowed');
            els.resumeHint.textContent = "Tombol akan aktif setelah waktu habis.";
            
            // Paksa fullscreen ulang saat suspensi dimulai
            enterFullscreen();

            let penaltyTime = SUSPENSION_TIME;
            updateSuspensionDisplay(penaltyTime);
            
            suspensionInterval = setInterval(() => {
                penaltyTime--;
                updateSuspensionDisplay(penaltyTime);
                
                // Cek terus apakah user keluar fullscreen, jika ya paksa lagi (walau browser membatasi ini)
                if (!document.fullscreenElement) {
                    // Kita tidak bisa auto-request fullscreen tanpa user interaction,
                    // tapi kita bisa pastikan UI tetap tertutup overlay
                }

                if (penaltyTime <= 0) {
                    clearInterval(suspensionInterval);
                    enableResume();
                }
            }, 1000);
        }

        function updateSuspensionDisplay(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            els.displays.suspension.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function enableResume() {
            els.btnResume.disabled = false;
            els.btnResume.classList.remove('bg-gray-600', 'text-gray-400', 'cursor-not-allowed');
            els.btnResume.classList.add('bg-blue-600', 'text-white', 'cursor-pointer');
            els.btnResume.textContent = "LANJUTKAN UJIAN SEKARANG";
            els.resumeHint.textContent = "Waktu hukuman selesai. Silakan lanjut.";
        }

        function resumeExam() {
            isSuspended = false;
            els.suspension.classList.add('hidden');
            els.frame.style.pointerEvents = 'auto'; 
            
            logActivity("RESUME", "Melanjutkan ujian setelah suspensi"); 

            currentTolerance = MAX_TOLERANCE; 
            updateToleranceDisplay();
            
            document.title = "Portal Ujian Aman";
            enterFullscreen();
        }

    </script>
</body>
</html>
